<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">


<!--

Example:

    <sm-stitch-picker></sm-stitch-picker>

    <sm-stitch-picker stitch="{{selectedstitch}}"></sm-stitch-picker>

    <sm-stitch-picker column-count=5 stitch-list='["a", "b"]'></sm-stitch-picker>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--paper-stitch-picker-color-size` | The size of each of the color boxes | `20px`
`--paper-stitch-picker-icon-size` | The size of the color picker icon | `24px`
`--paper-stitch-picker-icon` | Mixin applied to the color picker icon | `{}`

-->

<dom-module id="sm-stitch-picker">
  <template>
    <style>
      :host {
        display: inline-block;
        position: relative;

      }

      :host(:focus) {
        outline: none;
      }

      .stitch {
        box-sizing: border-box;
        width: var(--paper-stitch-picker-color-size, 24px);
        height: var(--paper-stitch-picker-color-size, 24px);
        display: inline-block;
        padding: 0;
        margin: 0;
        cursor: pointer;
        position: relative;

        text-align: center;
      }

      .stitch:hover, .stitch:focus {
        -webkit-transform: scale(1.3, 1.3);
        transform: scale(1.3, 1.3);
        outline: none;
        z-index: 1;
      }

      paper-button {
        --paper-button: {
          min-width: 2em;
          height: 2em;
          font-size: 2em;
        }
      }

      paper-item {
        --paper-item: {
          margin: 0;
          padding: 0;
          min-height: 0;
        };

        --paper-item-focused-before: {
          opacity: 0;
        };
      }

      paper-listbox {
        @apply --layout-horisontal;
        font-size: 0;
        overflow: hidden;
        @apply --layout-wrap;
        padding: 0;
      }
    </style>

    <paper-menu-button vertical-align="[[verticalAlign]]" horizontal-align="[[horizontalAlign]]">
      <paper-button
        id="iconButton"
        slot="dropdown-trigger" alt="stitch picker"
        raised
        noink$="[[noink]]">
        {{stitch.symbol}}
      </paper-button>
      <paper-listbox class="dropdown-content" id="container">
        <template is="dom-repeat" items="{{stitchList}}">
          <paper-item class="stitch" data="{{item}}">{{item.symbol}}</paper-item>
        </template>
      </paper-listbox>
    </paper-menu-button>
  </template>
  <script>
    Polymer({
      is: 'sm-stitch-picker',
      hostAttributes: {
        'tabindex': 0
      },
      listeners: {
        'paper-dropdown-open': '_onOpen',
        'iron-select': '_onStitchTap'
      },
      /**
       * Fired when a color has been selected
       *
       * @event stitch-picker-selected
       */
      properties: {

        stitch: {
          type: String,
          notify: true,
          observer: '_stitchChanged'
        },

        stitchList: {
          type: Array,
          value: function() {
            return [
              {
                color: 'green',
                symbol: String.fromCharCode('0x2764')
              },
              {
                color: 'red',
                symbol: String.fromCharCode('0x25BC')
              },
            ];
          }
        },
        /* The number of columns to display in the picker. This corresponds to
         * the number of generic colors (i.e. not counting the light/dark) variants
         * of a specific color) you are using in your `stitchList`. For example,
         * the Material Design palette has 18 colors */
        columnCount: {
          type: Number,
          value: 18
        },
        /**
         * The orientation against which to align the menu dropdown
         * horizontally relative to the dropdown trigger.
         */
        horizontalAlign: {
          type: String,
          value: 'right',
          reflectToAttribute: true
        },
        /**
         * The orientation against which to align the menu dropdown
         * vertically relative to the dropdown trigger.
         */
        verticalAlign: {
          type: String,
          value: 'top',
          reflectToAttribute: true
        },
        /**
         * If true, the stitch picker button will not produce a ripple effect when interacted
         * with via the pointer.
         */
        noink: {
          type: Boolean
        }
      },
      created: function() {
        // Note: we won't actually render these color boxes unless the menu is
        // actually tapped.
        this._renderedColors = false;
      },
      attached: function() {
        // Fit the color boxes in columns. We first need to get the width of
        // a color box (which is customizable), and then change the box's
        // width to fit all the columns.
        var sizeOfAColorDiv = this.getComputedStyleValue('--paper-swatch-picker-color-size');
        if (!sizeOfAColorDiv || sizeOfAColorDiv == '') {  // Default value case
          sizeOfAColorDiv = 24;
        } else {
          sizeOfAColorDiv = sizeOfAColorDiv.replace('px', '');
        }
        var rowCount = Math.ceil(this.stitchList.length / this.columnCount);
        this.$.container.style.height = rowCount * sizeOfAColorDiv + 'px';
        this.$.container.style.width = this.columnCount * sizeOfAColorDiv + 'px';
      },
      _addOverflowClass: function() {
        this.$.container.toggleClass('opened', true);
      },
      _removeOverflowClass: function() {
        this.$.container.toggleClass('opened', false);
      },
      _onOpen: function() {
        // Fill in the colors if we haven't already.
        if (this._renderedColors)
          return;
        var colorBoxes = this.$.container.querySelectorAll('.stitch');
        for (var i = 0; i < colorBoxes.length; i++) {
          colorBoxes[i].style.background = colorBoxes[i].data.color;
          colorBoxes[i].innerHTML = colorBoxes[i].data.symbol;
        }
        this._renderedColors = true;
      },
      _onStitchTap: function(event) {
        var item = event.detail.item;
        this.stitch = item.data;
        this.fire('stitch-picker-selected', {stitch: this.stitch});
      },
      _stitchChanged: function() {
        this.$.iconButton.style.background = this.stitch.color;
      }
    });
  </script>
</dom-module>