<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<dom-module id="stitch-auth">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <app-location id="location" route="{{route}}"></app-location>
    <paper-toast id="toast"></paper-toast>
  </template>

  <script src="https://cdn.auth0.com/js/auth0/9.3.1/auth0.min.js"></script>
  <script>
    (function () {
      const webAuth = new auth0.WebAuth({
        domain: 'stitch-marker.auth0.com',
        clientID: 'bjyzupUo4rEn7vvEzTtb2cUuhUsNcT2e',
        responseType: 'token id_token',
        audience: 'https://stitch-marker.auth0.com/userinfo',
        scope: 'openid email profile',
        redirectUri: `${location.origin}/auth`
      });

      class Auth extends Polymer.Element {
        static get is() { return 'stitch-auth'; }

        static get properties() {
          return {
            active: {
              type: Boolean,
              reflectToAttribute: true,
              observer: 'activeChanged'
            }
          }
        }

        activeChanged() {
          if (!this.active) return;

          if (window.location.hash) {
            webAuth.parseHash({ hash: window.location.hash }, (error, authResult) => {
              if (error) {
                this.errorDisplay(err);
                return;
              }

              this.setSession(authResult);
              window.location.hash = '';
              this.redirect();
            });
          } else {
            const authData = JSON.parse(localStorage.getItem("authData"));
            if (this.isAuthenticated()) {
              this.logout();
              this.redirect();
            }
            else {
              this.login();
            }
          }
        }

        setSession(authResult) {
          var expiresAt = JSON.stringify(
            authResult.expiresIn * 1000 + new Date().getTime()
          );

          let authData = {
            accessToken: authResult.accessToken,
            idToken: authResult.idToken,
            expiresAt: expiresAt,
            userEmail: authResult.idTokenPayload.email,
            userName: authResult.idTokenPayload.name
          };

          localStorage.setItem('authData', JSON.stringify(authData));
        }

        logout() {
          localStorage.removeItem('authData');
        }

        isAuthenticated() {
          const authData = JSON.parse(localStorage.getItem("authData"));
          return authData && new Date().getTime() < authData.expiresAt;
        }

        login() {
          webAuth.authorize();
        }

        async redirect() {
          await Promise.yield();
          this.set("route.path", "/");
        }

        errorDisplay(err) {
          this.$.toast.text = 'Error at login.';
          this.$.toast.open();
        }
      }
      customElements.define(Auth.is, Auth);
    }());
  </script>
</dom-module>
