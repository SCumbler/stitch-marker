<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="stitch-auth">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>
  
  <script>
    class Auth extends Polymer.Element {
      static get is() { return 'stitch-auth'; }

      ready() {
        debugger
        super.ready();

        var webAuth = new auth0.WebAuth({
          domain: 'stitch-marker.auth0.com',
          clientID: 'bjyzupUo4rEn7vvEzTtb2cUuhUsNcT2e',
          responseType: 'token id_token',
          audience: 'https://stitch-marker.auth0.com/userinfo',
          scope: 'openid',
          redirectUri: window.location.href
        });

        // buttons and event listeners
        var loginBtn = header.$.login;
        var logoutBtn = header.$.logout;

        loginBtn.addEventListener('click', function(e) {
            e.preventDefault();
            webAuth.authorize();
          });

        logoutBtn.addEventListener('click', this.logout);

        function handleAuthentication() {
            webAuth.parseHash(function(err, authResult) {
            if (authResult && authResult.accessToken && authResult.idToken) {
              debugger
                window.location.hash = '';
                setSession(authResult);
                loginBtn.style.display = 'none';
            } else if (err) {
                console.log(err);
                alert(
                'Error: ' + err.error + '. Check the console for further details.'
                );
            }
          });
        }

        // Set the time that the Access Token will expire at
        function setSession(authResult) {
          var expiresAt = JSON.stringify(
          authResult.expiresIn * 1000 + new Date().getTime()
          );
          localStorage.setItem('access_token', authResult.accessToken);
          localStorage.setItem('id_token', authResult.idToken);
          localStorage.setItem('expires_at', expiresAt);
        }
        
        handleAuthentication();
      }
      
      // Set the time that the Access Token will expire at
      setSession(authResult) {
        var expiresAt = JSON.stringify(
        authResult.expiresIn * 1000 + new Date().getTime()
        );
        localStorage.setItem('access_token', authResult.accessToken);
        localStorage.setItem('id_token', authResult.idToken);
        localStorage.setItem('expires_at', expiresAt);
      }

      // Remove tokens and expiry time from localStorage
      logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('id_token');
        localStorage.removeItem('expires_at');
        alert("User logout");
      }

      // check user authorization
      isAuthenticated() {
        var expiresAt = JSON.parse(localStorage.getItem('expires_at'));
        return new Date().getTime() < expiresAt;
      }

      // login
      authorize() {
        webAuth.authorize();
      }
    }
    
    customElements.define(Auth.is, Auth);
  </script>
</dom-module>
