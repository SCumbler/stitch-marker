<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="stitch-auth">
  <template>
    <style>
      :host {
        display: block;
      }
    </style> 
  </template>

  <script>
    class Auth extends Polymer.Element {
      static get is() { return 'stitch-auth'; }

      static get properties() {
        return {
          webAuth: {
            type: Object
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();

        this.webAuth = new auth0.WebAuth({
          domain: 'stitch-marker.auth0.com',
          clientID: 'bjyzupUo4rEn7vvEzTtb2cUuhUsNcT2e',
          responseType: 'token id_token',
          audience: 'https://stitch-marker.auth0.com/userinfo',
          scope: 'openid',
          redirectUri: 'http://localhost:8081/auth'
        });

        this.handleAuthentication();
      }
      
      // check authorization
      handleAuthentication() {
            this.webAuth.parseHash((err, authResult) => {
            if (authResult && authResult.accessToken && authResult.idToken) {
                window.location.hash = '';
                console.log(this);
                this.setSession(authResult);
            } else if (err) {
                console.log(err);
                alert(
                'Error: ' + err.error + '. Check the console for further details.'
                );
            }
          });
        }

      // Set the time that the Access Token will expire at
      setSession(authResult) {
        var expiresAt = JSON.stringify(
            authResult.expiresIn * 1000 + new Date().getTime()
          );
        localStorage.setItem('access_token', authResult.accessToken);
        localStorage.setItem('id_token', authResult.idToken);
        localStorage.setItem('expires_at', expiresAt);
        localStorage.setItem('is_authorized', this.isAuthenticated());
        this.redirectToMain();
      }

      // Remove tokens and expiry time from localStorage
      logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('id_token');
        localStorage.removeItem('expires_at');
        localStorage.setItem('is_authorized', this.isAuthenticated());
        this.redirectToMain();
      }

      // check user authorization
      isAuthenticated() {
        var expiresAt = JSON.parse(localStorage.getItem('expires_at'));
        return new Date().getTime() < expiresAt;
      }

      // login
      authorize() {
        this.webAuth.authorize();
      }

      // redirect to main
      redirectToMain() { 
        window.location = "http://localhost:8081/"; 
      } 
    }
    
    customElements.define(Auth.is, Auth);
  </script>
</dom-module>
