<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<script src="https://cdn.auth0.com/js/auth0/9.3.1/auth0.min.js"></script>

<dom-module id="stitch-auth">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <app-location id="location" route="{{route}}"></app-location>
    <paper-toast id="toast"></paper-toast>
  </template>

  <script>
    class Auth extends Polymer.Element {
      static get is() { return 'stitch-auth'; }

      static get properties() {
        return {
          webAuth: {
            type: Object
          },
          active: {
            type: Boolean,
            reflectToAttribute: true,
            observer: '_activeChanged'
          }
        }
      }

      _activeChanged() {
        if (this.active) {
          this.authorizeToggle();
        }
      }

      ready() {
        super.ready();

        this.webAuth = new auth0.WebAuth({
          domain: 'stitch-marker.auth0.com',
          clientID: 'bjyzupUo4rEn7vvEzTtb2cUuhUsNcT2e',
          responseType: 'token id_token',
          audience: 'https://stitch-marker.auth0.com/userinfo',
          scope: 'openid email profile',
          redirectUri: location.origin + '/auth'
        });
      }

      connectedCallback() {
        super.connectedCallback();
        debugger
        this.handleAuthentication();
      }

      authorizeToggle() {
        debugger
        const toggle = this.isAuthenticated();
        if (toggle) {
          this.logout();
        }
        else {
          this.login();
        }
      }

      handleAuthentication() {
        debugger
        this.webAuth.parseHash((err, authResult) => {
          if (authResult && authResult.accessToken && authResult.idToken) {
            debugger
            this.setSession(authResult);
          } else if (err) {
            this.errorDisplay(err);
          }
        });
      }

      setSession(authResult) {
        var expiresAt = JSON.stringify(
          authResult.expiresIn * 1000 + new Date().getTime()
        );
        let auth_data = {
          access_token: authResult.accessToken,
          id_token: authResult.idToken,
          expires_at: expiresAt,
          user_email: authResult.idTokenPayload.email,
          user_name: authResult.idTokenPayload.name
        };
        localStorage.setItem('auth_data', JSON.stringify(auth_data));
        this.redirectToMainWindow();
      }

      logout() {
        localStorage.removeItem('auth_data');
        this.redirectToMainWindow();
      }

      isAuthenticated() {
        const auth_data = JSON.parse(localStorage.getItem("auth_data"));
        if (auth_data == null) return false;
        return new Date().getTime() < auth_data.expires_at;
      }

      login() {
        this.webAuth.authorize();
      }

      redirectToMainWindow() {
        this.set('route.path', '/landing');
      }

      errorDisplay(err) {
        this.$.toast.text = 'Error at login.';
        this.$.toast.open();
      }
    }

    customElements.define(Auth.is, Auth);
  </script>
</dom-module>
