<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">


<dom-module id="stitch-pattern-card">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-card {
        width: 300px;
        height: 320px;
      }

      #title {
        white-space: nowrap;
        overflow: hidden;
        font-size: 18px;
        text-overflow: ellipsis;
        padding: 0;
      }

      #size {
        font-size: 14px;
      }

      paper-button {
        font-size: 14px;
        float: left;
        color: var(--google-blue-500);
        padding: 11px 0px;
      }

      .card-actions {
        border-top: 1px solid #e8e8e8;
        padding: 5px 0;
        position: relative;
      }

      #delete {
        color: #616161;
        float: right;
        margin-right: 5px;
      }
    </style>

    <app-location id="location" route="{{route}}"></app-location>
    <paper-card image="[[dataUrl]]">
      <div class="card-content">
        <div class="edit-name">
          <div id="title" title="[[patternInfo.title]]">[[patternInfo.title]]</div>
        </div>
        <div id="size">[[patternInfo.width]] Ã— [[patternInfo.height]]</div>
      </div>
      <div class="card-actions">
        <paper-button on-tap="open">Open</paper-button>
        <paper-icon-button id="delete" icon="delete" on-tap="delete"></paper-icon-button>
      </div>
    </paper-card>
  </template>
  <script>
    class PatternCard extends Polymer.Element {
      static get is() {
        return "stitch-pattern-card";
      }
      static get properties() {
        return {
          patternInfo: {
            type: Object,
            value: {}
          },
          dataUrl: {
            type: String,
            computed: "getDataUrl(patternInfo)"
          }
        }
      }

      open() {
        localStorage.setItem('patternInfo', JSON.stringify(this.patternInfo));
        const authData = JSON.parse(localStorage.getItem("authData"));
        if (!authData) return;
        this.set('route.path', '/marker');
      }

      async getDataUrl(patternInfo) {
        const authData = JSON.parse(localStorage.getItem("authData"));
        let img = '';

        await fetch(SM.apiUrl + patternInfo.links.find(link => link.rel === 'thumbnail').href,
          {
            headers: {
              "authorization": "Bearer " + authData.accessToken
            }
          }).then((response) => {
            response.arrayBuffer().then((buffer) => {
              let base64Flag = 'data:image/png;base64,';
              let binary = '';
              let bytes = [].slice.call(new Uint8Array(buffer));
              bytes.forEach((b) => binary += String.fromCharCode(b));
              let imageStr = window.btoa(binary);
              img = base64Flag + imageStr;
            });
          });
        await Promise.yield();
        debugger
 
        return img;
        // return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAADICAYAAABS39xVAAAABHNCSVQICAgIfAhkiAAABXxJREFUeJzt3TFoXWUcxuETiSLYxTqE7iJCEAIOQjMIks2h2UQyu1ScHZwdnEUX5yJOtoiTQXCI4OZgoIi7ZGimCqJgnRwaJN8/zdcv5z3nedZ7OfckLT9O4OW7G1PB/t72o9Z7Pnzn7XNf/+Srb5ufc2fntHI7TZ///lKX6xydNH9seMzu1salr3H7xoMOd1Jz8PP1IZ9z9/D48r+YaZqe6XERgBEEC4hRekyr/EnY4s89zur1f6KHUX8aTVPen40Vrd+fPwmB1REsIIZgATEEC4ghWEAMwQJiCBYQQ7CAGJu9LtRjBGgUuhy9RqHX/vzy0td4+Py7zfdU7rfXuLT1/7PHsHSpPGEBMQQLiCFYQAzBAmIIFhBDsIAYggXEECwgRrfh6Ci9RqGjTrsceZJlmh6j0O0f32t/zs3251TGpXNSGVnP7VTSHjxhATEEC4ghWEAMwQJiCBYQQ7CAGIIFxBAsIMaw4Wiv00Qr5vQV6CNPslyiyjC0xzUq49Jb0/uXvpeKyjh6raeSesICYggWEEOwgBiCBcQQLCCGYAExBAuIsbm/t90cfYzaNY38xuYeh8dVpB0MN9I/n75ZeNev57762uuv9LkZInjCAmIIFhBDsIAYggXEECwghmABMQQLiCFYQIy4b34eqcfhcaVvHd5pj0vTDvmr3O+9D35ovqfHvwHL4QkLiCFYQAzBAmIIFhBDsIAYggXEECwghmABMQxHn7K0bx2GOfOEBcQQLCCGYAExBAuIIVhADMECYggWEEOwgBirHY76mvQMxze/OPd1J5KuiycsIIZgATEEC4ghWEAMwQJiCBYQQ7CAGIIFxFjkcNTXpGe4db99iuq9Vz879/XWsLTnvYyyu7XRfM/tGw8G3Mn8eMICYggWEEOwgBiCBcQQLCCGYAExBAuIIVhAjM27h8fNldrBtP2o9Z47O6fnvl4Zuh2dtAefIznt8urNadA5ytxGoZUhdqUjLft77c54wgJiCBYQQ7CAGIIFxBAsIIZgATEEC4ixyAP8KpZ4eNzX3/3SfE+Pb6t++fpzl77GmrU2i0tU2VhVeMICYggWEEOwgBiCBcQQLCCGYAExBAuIIVhAjEsfuvWf1jCs11iucpjYWv12+teQzxk5HG39TCPvZYmDzzkdzlfhCQuIIVhADMECYggWEEOwgBiCBcQQLCCGYAEx4k4crYz30sallcFnZSDZY0RZuZde91u5zk9vPWy+h/83ahQ6Tf2GoS2esIAYggXEECwghmABMQQLiCFYQAzBAmIIFhCj24mjLZVh2cgTHec0Lq383G98f23AnUzTx3882+U6H73wd/M9RqFPbomj0ApPWEAMwQJiCBYQQ7CAGIIFxBAsIIZgATEEC4gxbDhaMbdx6RodfvNil+sYjj65tY5CKzxhATEEC4ghWEAMwQJiCBYQQ7CAGIIFxBAsIMashqMVxqVXrzIuXetwtMdJtmsdhVZ+bk9YQAzBAmIIFhBDsIAYggXEECwghmABMTav+gYuqrLVOJhstZ6mysZqiUYerDfK7laf2z06GTP58oQFxBAsIIZgATEEC4ghWEAMwQJiCBYQQ7CAGFEjt55GHW5moLocPQ7nm5tew9GWyrDUAX7AoggWEEOwgBiCBcQQLCCGYAExBAuIIVhAjNUOR0dJ+/ZdQ1fOqgxmWwNUw1FgdQQLiCFYQAzBAmIIFhBDsIAYggXEECwghuEoj6kMXY1LOavHaayGo8CiCBYQQ7CAGIIFxBAsIIZgATEEC4ghWEAMw1EuzLiUi6oMSw1HgUURLCCGYAExBAuIIVhADMECYggWEEOwgBiCBcQQLCCGYAExBAuIIVhADMECYggWEEOwgBiCBcQQLCCGYAEx/gXhVSDsOJK6egAAAABJRU5ErkJggg==";
      }

      async delete() {
        const authData = JSON.parse(localStorage.getItem("authData"));
        const response = await fetch(SM.apiUrl + this.patternInfo.links.find(link => link.rel === 'self').href,
          {
            method: 'DELETE',
            headers: {
              "authorization": "Bearer " + authData.accessToken
            }
          });
        if (response.status === 200)
          this.dispatchEvent(new CustomEvent('delete'));
      }
    }
    customElements.define(PatternCard.is, PatternCard);
  </script>
</dom-module>
